#!/bin/bash
#
# SOC Toolkit Test Suite v1.2
# Author: Furkan Dinรงer
# GitHub: https://github.com/frkndncr/soc-toolkit
#

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

PASSED=0
FAILED=0

echo -e "${CYAN}"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ           ๐งช SOC Toolkit Test Suite v1.2                      โ"
echo "โ           github.com/frkndncr/soc-toolkit                     โ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo -e "${NC}"

run_test() {
    local name="$1"
    local cmd="$2"
    echo -e "${BLUE}[TEST]${NC} $name"
    if eval "$cmd" > /dev/null 2>&1; then
        echo -e "${GREEN}  โ PASSED${NC}"
        ((PASSED++))
    else
        echo -e "${RED}  โ FAILED${NC}"
        ((FAILED++))
    fi
}

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${CYAN}Phase 1: Basic Tests${NC}"
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

run_test "Version Check" "soc --version | grep -q 'SOC Toolkit'"
run_test "Help Menu" "soc --help | grep -q 'IOC'"
run_test "Provider List" "soc --providers | grep -q 'ThreatFox'"
run_test "Config Display" "soc --config | grep -q 'Version'"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${CYAN}Phase 2: IOC Lookup Tests${NC}"
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

run_test "IP Lookup" "soc 8.8.8.8 -q --brief"
run_test "Domain Lookup" "soc google.com -q --brief"
run_test "Hash Lookup" "soc 44d88612fea8a8f36de82e1278abb02f -q --brief"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${CYAN}Phase 3: IOC Extraction Tests${NC}"
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

# Create test file
cat > /tmp/test_soc.log << 'EOF'
Connection from 185.220.101.45
DNS query: evil-domain.com
Hash: 44d88612fea8a8f36de82e1278abb02f
URL: https://malware.xyz/payload
Email: test@phishing.ru
CVE-2024-1234 exploit attempt
EOF

run_test "IOC Extraction" "soc -e /tmp/test_soc.log -q | grep -q 'IP'"
run_test "Extraction with Private IPs" "echo '10.0.0.1 test' >> /tmp/test_soc.log && soc -e /tmp/test_soc.log --include-private -q"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${CYAN}Phase 4: Export Tests${NC}"
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

run_test "JSON Export" "soc 8.8.8.8 -q --json /tmp/test.json && test -f /tmp/test.json"
run_test "Markdown Export" "soc 8.8.8.8 -q --md /tmp/test.md && test -f /tmp/test.md"
run_test "CSV Export" "soc 8.8.8.8 -q --csv /tmp/test.csv && test -f /tmp/test.csv"
run_test "Raw JSON" "soc 8.8.8.8 -q --raw | python3 -c 'import json,sys;json.load(sys.stdin)'"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${CYAN}Phase 5: Batch & Stdin Tests${NC}"
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo -e "8.8.8.8\ngoogle.com" > /tmp/test_iocs.txt
run_test "Batch Processing" "soc -f /tmp/test_iocs.txt -q"
run_test "Stdin Input" "echo '8.8.8.8' | soc --stdin -q"

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${CYAN}Phase 6: Directory Tests${NC}"
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

run_test "Log Directory" "mkdir -p ~/.soc-toolkit/logs"
run_test "Cache Directory" "mkdir -p ~/.soc-toolkit/cache"

# Cleanup
rm -f /tmp/test_soc.log /tmp/test.json /tmp/test.md /tmp/test.csv /tmp/test_iocs.txt 2>/dev/null

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
echo -e "\n${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"
echo -e "${CYAN}                    ๐ TEST SUMMARY                             ${NC}"
echo -e "${CYAN}โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ${NC}"

TOTAL=$((PASSED + FAILED))
echo -e ""
echo -e "  ${GREEN}โ Passed:${NC}  $PASSED"
echo -e "  ${RED}โ Failed:${NC}  $FAILED"
echo -e "  Total:    $TOTAL"
echo -e ""

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}โ ALL TESTS PASSED!${NC}"
    exit 0
else
    echo -e "${RED}โ SOME TESTS FAILED${NC}"
    exit 1
fi
